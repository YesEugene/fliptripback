# Миграция для поддержки интересов в tour_tags

## Проблема
Таблица `tour_tags` изначально была создана с `PRIMARY KEY (tour_id, tag_id)`, что означает, что `tag_id` не может быть NULL. Но для поддержки интересов (interests) нужно, чтобы `tag_id` мог быть NULL, когда используется `interest_id`.

## Решение
Примените миграцию `fix-tour-tags-nullable.sql` в Supabase. Эта миграция:
1. Убирает PRIMARY KEY constraint с `(tour_id, tag_id)`
2. Делает `tag_id` nullable
3. Добавляет колонку `interest_id`
4. Добавляет check constraint для обеспечения, что либо `tag_id`, либо `interest_id` установлен
5. Создает уникальные индексы для обоих случаев

## Шаги

1. **Откройте Supabase Dashboard**
   - Перейдите на https://supabase.com/dashboard
   - Выберите ваш проект

2. **Откройте SQL Editor**
   - В левом меню нажмите "SQL Editor"
   - Нажмите "New query"

3. **Скопируйте и выполните SQL из файла `fix-tour-tags-nullable.sql`**
   
   **ВАЖНО:** Эта миграция удаляет PRIMARY KEY constraint, поэтому убедитесь, что у вас есть резервная копия данных!
   
   Миграция выполняет следующие шаги:
   - Удаляет PRIMARY KEY constraint с `(tour_id, tag_id)`
   - Делает `tag_id` nullable
   - Добавляет колонку `interest_id`
   - Создает check constraint для обеспечения целостности данных
   - Создает уникальные индексы для обоих случаев (tag_id и interest_id)

4. **Проверьте результат**
   - Убедитесь, что миграция выполнилась без ошибок
   - Проверьте, что колонка `interest_id` появилась в таблице `tour_tags`

## После применения миграции

1. Теги (интересы) должны сохраняться при сохранении тура
2. Теги должны загружаться при загрузке тура
3. Теги должны отображаться в визуалайзере после перезагрузки страницы

## Проверка

После применения миграции:
1. Добавьте интересы к туру
2. Сохраните тур
3. Перезагрузите страницу
4. Интересы должны остаться на месте

## Если миграция уже применена

Если колонка `interest_id` уже существует, миграция не изменит ничего (используется `IF NOT EXISTS`), но добавит индексы и ограничения, если их нет.

