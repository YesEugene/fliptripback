# План безопасной миграции: создание таблицы admins

## Текущая ситуация

### Как работает админ-доступ сейчас

1. **Хардкод-логин (`AdminLoginPage.jsx`):**
   - Email: `yes.stroynov@gmail.com`
   - Password: `fliptrip13`
   - Создает объект: `{ id: 'admin-1', name: 'Admin', email: 'yes.stroynov@gmail.com', role: 'admin' }`
   - Сохраняется в `localStorage`, **НЕ в БД**
   - Токен генерируется локально (base64)

2. **Проверка доступа:**
   - Админ-панель использует `getCurrentUser()` из `localStorage`
   - Нет проверки в БД
   - Просто проверяет наличие `user` объекта

3. **Таблица `users`:**
   - Содержит всех пользователей с `role: 'admin'`, `'guide'`, `'creator'`, `'user'`
   - Используется для обычного логина через `/api/auth-login`

### Проблема

Пользователь залогинен через хардкод, поэтому:
- Его запись **НЕ в БД**
- `id = 'admin-1'` (не UUID)
- При миграции может потерять доступ, если не создать запись в БД

## План безопасной миграции

### Этап 1: Анализ текущих данных (БЕЗ ИЗМЕНЕНИЙ)

**Проверить:**
1. Сколько админов в таблице `users` с `role = 'admin'`
2. Есть ли запись для `yes.stroynov@gmail.com` в `users`
3. Какие поля есть в таблице `users`

**SQL запросы:**
```sql
-- Проверить админов в users
SELECT id, email, name, role, created_at 
FROM users 
WHERE role = 'admin';

-- Проверить конкретного админа
SELECT * FROM users WHERE email = 'yes.stroynov@gmail.com';
```

### Этап 2: Создание таблицы `admins` (БЕЗ МИГРАЦИИ ДАННЫХ)

**Создать таблицу:**
```sql
CREATE TABLE IF NOT EXISTS admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  bio TEXT,
  avatar_url VARCHAR(500),
  permissions JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Создать индекс для быстрого поиска
CREATE INDEX IF NOT EXISTS idx_admins_id ON admins(id);
```

**Важно:** Таблица создается пустой, данные не переносятся.

### Этап 3: Создание записи для хардкод-админа (БЕЗОПАСНО)

**Вариант A: Создать запись с реальным UUID**

1. Сгенерировать UUID для админа
2. Создать запись в `users`:
   ```sql
   INSERT INTO users (id, email, password_hash, name, role, is_active, created_at)
   VALUES (
     'сгенерированный-uuid',
     'yes.stroynov@gmail.com',
     '$2b$10$...', -- хеш пароля 'fliptrip13'
     'Admin',
     'admin',
     true,
     NOW()
   );
   ```

3. Создать запись в `admins`:
   ```sql
   INSERT INTO admins (id, name, created_at, updated_at)
   VALUES (
     'тот-же-uuid',
     'Admin',
     NOW(),
     NOW()
   );
   ```

4. Обновить `AdminLoginPage.jsx` для использования реального UUID

**Вариант B: Оставить хардкод как fallback (БЕЗОПАСНЕЕ)**

1. Оставить хардкод-логин как есть
2. После успешного хардкод-логина проверять БД
3. Если записи нет - создавать автоматически
4. Это гарантирует, что доступ не сломается

### Этап 4: Миграция существующих админов из `users` в `admins`

**Только после того, как хардкод-админ работает:**

```sql
-- Мигрировать существующих админов
INSERT INTO admins (id, name, created_at, updated_at)
SELECT 
  id,
  COALESCE(name, email) as name,
  created_at,
  updated_at
FROM users
WHERE role = 'admin'
  AND id NOT IN (SELECT id FROM admins) -- избежать дубликатов
ON CONFLICT (id) DO NOTHING;
```

### Этап 5: Создание API для работы с профилем админа

**Создать `api/admin-profile.js` (аналогично `guide-profile.js`):**
- GET - получить профиль админа
- PUT - обновить/создать профиль админа
- Использовать `admins.id` = `users.id` (не `user_id`)

### Этап 6: Обновление фронтенда

**Обновить страницу настроек админа:**
- Использовать `/api/admin-profile` вместо `/api/guide-profile`
- Работать с таблицей `admins`

## Критические моменты безопасности

### ⚠️ НЕ ДЕЛАТЬ:

1. ❌ **НЕ удалять записи из `users`** - они нужны для аутентификации
2. ❌ **НЕ менять структуру `users`** - это сломает логин
3. ❌ **НЕ переносить админов из `users`** - они должны остаться там
4. ❌ **НЕ менять хардкод-логин** до создания записи в БД

### ✅ ДЕЛАТЬ:

1. ✅ **Создать таблицу `admins`** - только структура
2. ✅ **Создать запись для хардкод-админа** - с реальным UUID
3. ✅ **Мигрировать существующих админов** - только после тестирования
4. ✅ **Сохранить `users` для аутентификации** - все роли остаются там

## Рекомендуемый подход

### Вариант 1: Минимальные изменения (РЕКОМЕНДУЮ)

**Структура:**
- `users` - **остается для всех** (аутентификация)
- `guides` - профили гидов/креаторов (дополнительные данные)
- `admins` - профили админов (дополнительные данные)

**Логика:**
- Все логинятся через `users` (по `email` + `password_hash`)
- После логина проверяется `role`
- Если `role = 'admin'` - загружается профиль из `admins`
- Если `role = 'guide'` или `'creator'` - загружается профиль из `guides`
- Если `role = 'user'` - профиля нет

**Преимущества:**
- Минимальные изменения
- Не ломает текущий доступ
- `users` остается единой точкой аутентификации
- Легко расширять профили в будущем

### Вариант 2: Полное разделение (НЕ РЕКОМЕНДУЮ)

**Проблемы:**
- Нужно менять всю логику аутентификации
- Высокий риск сломать доступ
- Сложная миграция
- Нужно проверять все три таблицы при логине

## Порядок выполнения (безопасный)

1. ✅ **Анализ** (текущий этап) - понять структуру
2. ⏳ **Создать таблицу `admins`** - только структура, без данных
3. ⏳ **Создать запись для хардкод-админа** - с реальным UUID
4. ⏳ **Обновить `AdminLoginPage.jsx`** - использовать UUID из БД
5. ⏳ **Протестировать доступ** - убедиться, что работает
6. ⏳ **Мигрировать существующих админов** - из `users` в `admins`
7. ⏳ **Создать `api/admin-profile.js`** - для работы с профилем
8. ⏳ **Обновить страницу настроек админа** - использовать новый API
9. ⏳ **Финальное тестирование** - все функции работают

## Важные замечания

1. **Хардкод-логин должен работать** до создания записи в БД
2. **После создания записи** можно обновить логин, но оставить fallback
3. **`users` таблица НЕ меняется** - все роли остаются там
4. **`admins` и `guides`** - только для дополнительных данных профиля
5. **Аутентификация** - всегда через `users` таблицу

## Вопросы для уточнения

1. Есть ли в БД запись для `yes.stroynov@gmail.com`?
2. Сколько админов сейчас в таблице `users`?
3. Нужно ли сохранить хардкод-логин как fallback?
4. Или создать реальную запись в БД и убрать хардкод?


